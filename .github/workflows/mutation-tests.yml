name: Mutation Testing

# Mutation testing runs on a schedule (weekly) and manual trigger
# It does not run on PRs because it's slow (can take 10-30+ minutes)
# This is for quality insights, not PR blocking

on:
  schedule:
    # Run every Monday at 2:00 AM UTC
    - cron: '0 2 * * 1'

  workflow_dispatch:
    inputs:
      project:
        description: 'Project to test (domain, application, or all)'
        required: false
        default: 'all'
        type: choice
        options:
          - domain
          - application
          - all
      threshold:
        description: 'Mutation score threshold'
        required: false
        default: '60'
        type: choice
        options:
          - '50'
          - '60'
          - '80'

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 'true'
  DOTNET_CLI_TELEMETRY_OPTOUT: 'true'

jobs:
  mutation-testing:
    name: Run Mutation Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Mutation testing can be slow

    strategy:
      fail-fast: false
      matrix:
        project: ${{ github.event_name == 'workflow_dispatch' && fromJSON(format('["{0}"]', github.event.inputs.project)) || fromJSON('["domain", "application"]') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better diff analysis

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore .NET tools
        run: dotnet tool restore

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --configuration Release --no-restore

      - name: Run unit tests (verify tests pass first)
        run: dotnet test YoutubeRag.Tests.Unit/YoutubeRag.Tests.Unit.csproj --configuration Release --no-build --verbosity minimal

      - name: Determine project path
        id: project-path
        run: |
          if [ "${{ matrix.project }}" == "domain" ]; then
            echo "path=YoutubeRag.Domain/YoutubeRag.Domain.csproj" >> $GITHUB_OUTPUT
            echo "name=Domain" >> $GITHUB_OUTPUT
          elif [ "${{ matrix.project }}" == "application" ]; then
            echo "path=YoutubeRag.Application/YoutubeRag.Application.csproj" >> $GITHUB_OUTPUT
            echo "name=Application" >> $GITHUB_OUTPUT
          fi

      - name: Run Stryker mutation testing
        id: stryker
        continue-on-error: true  # Don't fail workflow if score is below threshold
        run: |
          dotnet stryker \
            --project "${{ steps.project-path.outputs.path }}" \
            --test-project "YoutubeRag.Tests.Unit/YoutubeRag.Tests.Unit.csproj" \
            --reporter html \
            --reporter json \
            --reporter cleartext \
            --reporter progress \
            --output "StrykerOutput/${{ steps.project-path.outputs.name }}" \
            --concurrency 2 \
            --mutation-level standard \
            --verbosity info

      - name: Parse mutation score
        id: parse-score
        if: always()
        run: |
          OUTPUT_DIR="StrykerOutput/${{ steps.project-path.outputs.name }}"

          if [ -f "$OUTPUT_DIR/reports/mutation-report.json" ]; then
            SCORE=$(jq -r '.files.mutationScore' "$OUTPUT_DIR/reports/mutation-report.json" 2>/dev/null || echo "0")
            KILLED=$(jq -r '.files.totalMutants.killed' "$OUTPUT_DIR/reports/mutation-report.json" 2>/dev/null || echo "0")
            SURVIVED=$(jq -r '.files.totalMutants.survived' "$OUTPUT_DIR/reports/mutation-report.json" 2>/dev/null || echo "0")
            TIMEOUT=$(jq -r '.files.totalMutants.timeout' "$OUTPUT_DIR/reports/mutation-report.json" 2>/dev/null || echo "0")
            NO_COVERAGE=$(jq -r '.files.totalMutants.noCoverage' "$OUTPUT_DIR/reports/mutation-report.json" 2>/dev/null || echo "0")

            echo "score=$SCORE" >> $GITHUB_OUTPUT
            echo "killed=$KILLED" >> $GITHUB_OUTPUT
            echo "survived=$SURVIVED" >> $GITHUB_OUTPUT
            echo "timeout=$TIMEOUT" >> $GITHUB_OUTPUT
            echo "no_coverage=$NO_COVERAGE" >> $GITHUB_OUTPUT

            TOTAL=$((KILLED + SURVIVED + TIMEOUT + NO_COVERAGE))
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
          else
            echo "score=0" >> $GITHUB_OUTPUT
            echo "killed=0" >> $GITHUB_OUTPUT
            echo "survived=0" >> $GITHUB_OUTPUT
            echo "timeout=0" >> $GITHUB_OUTPUT
            echo "no_coverage=0" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload mutation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mutation-report-${{ matrix.project }}
          path: StrykerOutput/${{ steps.project-path.outputs.name }}/reports/
          retention-days: 30

      - name: Upload JSON report for badges
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mutation-json-${{ matrix.project }}
          path: StrykerOutput/${{ steps.project-path.outputs.name }}/reports/mutation-report.json
          retention-days: 90

      - name: Comment mutation score
        if: always() && steps.parse-score.outputs.score != '0'
        run: |
          SCORE="${{ steps.parse-score.outputs.score }}"
          KILLED="${{ steps.parse-score.outputs.killed }}"
          SURVIVED="${{ steps.parse-score.outputs.survived }}"
          TIMEOUT="${{ steps.parse-score.outputs.timeout }}"
          NO_COVERAGE="${{ steps.parse-score.outputs.no_coverage }}"
          TOTAL="${{ steps.parse-score.outputs.total }}"

          echo "## Mutation Testing Results - ${{ steps.project-path.outputs.name }}"
          echo ""
          echo "### Score: ${SCORE}%"
          echo ""
          echo "| Status | Count | Percentage |"
          echo "|--------|-------|------------|"
          echo "| Killed | $KILLED | $(awk "BEGIN {printf \"%.1f\", ($KILLED/$TOTAL)*100}")% |"
          echo "| Survived | $SURVIVED | $(awk "BEGIN {printf \"%.1f\", ($SURVIVED/$TOTAL)*100}")% |"
          echo "| Timeout | $TIMEOUT | $(awk "BEGIN {printf \"%.1f\", ($TIMEOUT/$TOTAL)*100}")% |"
          echo "| No Coverage | $NO_COVERAGE | $(awk "BEGIN {printf \"%.1f\", ($NO_COVERAGE/$TOTAL)*100}")% |"
          echo "| **Total** | **$TOTAL** | **100%** |"
          echo ""
          echo "### Thresholds"
          echo "- High: >= 80% (excellent)"
          echo "- Low: >= 60% (acceptable)"
          echo "- Break: >= ${{ github.event.inputs.threshold || '60' }}% (minimum)"
          echo ""

          if (( $(echo "$SCORE >= 80" | bc -l) )); then
            echo "**Status: Excellent** - Test quality is very high"
          elif (( $(echo "$SCORE >= 60" | bc -l) )); then
            echo "**Status: Good** - Test quality is acceptable"
          elif (( $(echo "$SCORE >= 50" | bc -l) )); then
            echo "**Status: Fair** - Consider improving test coverage"
          else
            echo "**Status: Needs Improvement** - Test quality needs attention"
          fi

  summary:
    name: Mutation Testing Summary
    runs-on: ubuntu-latest
    needs: mutation-testing
    if: always()

    steps:
      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          pattern: mutation-json-*
          path: reports/

      - name: Generate summary
        run: |
          echo "# Mutation Testing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Run Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for report in reports/*/mutation-report.json; do
            if [ -f "$report" ]; then
              PROJECT=$(basename $(dirname "$report"))
              PROJECT=${PROJECT#mutation-json-}

              SCORE=$(jq -r '.files.mutationScore' "$report" 2>/dev/null || echo "N/A")

              echo "## $PROJECT" >> $GITHUB_STEP_SUMMARY
              echo "Mutation Score: **${SCORE}%**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the HTML reports from the artifacts section for detailed analysis." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Mutation testing is for quality insights only and does not block PRs." >> $GITHUB_STEP_SUMMARY
