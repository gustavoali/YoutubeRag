# CI Pipeline - Build, Test, and Code Coverage
# Triggers on push to develop/master and PRs to these branches
name: CI Pipeline

on:
  push:
    branches: [ develop, master ]
  pull_request:
    branches: [ develop, master ]
    types: [opened, synchronize, reopened]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  NUGET_XMLDOC_MODE: skip

jobs:
  # Job 1: Build and Test with Code Coverage
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    # Service containers for integration tests
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      # Step 1: Checkout code
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones disabled for better analysis

      # Step 2: Setup .NET SDK
      - name: Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # Step 3: Cache NuGet packages
      - name: Cache NuGet Packages
        uses: actions/cache@v3
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json', '**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # Step 4: Restore dependencies
      - name: Restore Dependencies
        run: dotnet restore YoutubeRag.sln

      # Step 5: Build solution
      - name: Build Solution
        run: dotnet build YoutubeRag.sln --configuration Release --no-restore

      # Step 6: Run tests with code coverage
      - name: Run Tests with Coverage
        env:
          # Test environment variables
          ConnectionStrings__DefaultConnection: "Server=localhost;Port=3306;Database=test_db;User=root;Password=test_password;AllowPublicKeyRetrieval=True;"
          Redis__ConnectionString: "localhost:6379"
          JWT__Secret: "TestSecretKeyForJWTTokenGenerationMinimum256Bits!"
          JWT__Issuer: "TestIssuer"
          JWT__Audience: "TestAudience"
          ASPNETCORE_ENVIRONMENT: Testing
        run: |
          # Install coverage tools
          dotnet tool install --global coverlet.console
          dotnet tool install --global dotnet-reportgenerator-globaltool

          # Run tests with coverage
          dotnet test YoutubeRag.sln \
            --configuration Release \
            --no-build \
            --verbosity normal \
            --logger "trx;LogFileName=test-results.trx" \
            --logger "console;verbosity=detailed" \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura

      # Step 7: Generate code coverage report
      - name: Generate Coverage Report
        if: always()
        run: |
          reportgenerator \
            -reports:"TestResults/**/coverage.cobertura.xml" \
            -targetdir:"CoverageReport" \
            -reporttypes:"HtmlInline_AzurePipelines;Cobertura;Badges;JsonSummary" \
            -verbosity:"Info"

      # Step 8: Upload test results
      - name: Upload Test Results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results
          path: |
            TestResults/**/*.trx
            TestResults/**/*.xml
          retention-days: 30

      # Step 9: Upload coverage reports
      - name: Upload Coverage Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: coverage-report
          path: CoverageReport/
          retention-days: 30

      # Step 10: Upload coverage to Codecov
      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
        with:
          files: 'TestResults/**/coverage.cobertura.xml'
          flags: unittests
          name: codecov-ubuntu
          fail_ci_if_error: false

      # Step 11: Check code coverage threshold
      - name: Check Coverage Threshold
        if: always() && hashFiles('TestResults/**/coverage.cobertura.xml') != ''
        run: |
          # Install xml parsing tool
          sudo apt-get update && sudo apt-get install -y xmlstarlet

          # Parse coverage from the report
          COVERAGE_FILE=$(find TestResults -name "coverage.cobertura.xml" | head -1)
          if [ -f "$COVERAGE_FILE" ]; then
            LINE_RATE=$(xmlstarlet sel -t -v "//coverage/@line-rate" "$COVERAGE_FILE")
            COVERAGE=$(echo "$LINE_RATE * 100" | bc -l | cut -d. -f1)

            echo "Code Coverage: ${COVERAGE}%"

            # Check if coverage meets threshold
            THRESHOLD=80
            if [ "$COVERAGE" -lt "$THRESHOLD" ]; then
              echo "::warning::Code coverage ${COVERAGE}% is below the required threshold of ${THRESHOLD}%"
            else
              echo "::notice::Code coverage ${COVERAGE}% meets the required threshold of ${THRESHOLD}%"
            fi
          else
            echo "::warning::No coverage file found"
          fi

      # Step 12: Publish application
      - name: Publish Application
        run: dotnet publish YoutubeRag.Api/YoutubeRag.Api.csproj --configuration Release --no-build --output ./publish

      # Step 13: Upload published artifacts
      - name: Upload Published Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: published-app
          path: ./publish
          retention-days: 30

  # Job 2: Code Quality Analysis
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # Run .NET code analysis
      - name: Run Code Analysis
        run: |
          dotnet restore YoutubeRag.sln
          dotnet build YoutubeRag.sln --configuration Release --no-restore \
            /p:EnableNETAnalyzers=true \
            /p:AnalysisLevel=latest \
            /p:EnforceCodeStyleInBuild=true

      # Check code formatting
      - name: Check Code Format
        run: |
          dotnet format YoutubeRag.sln --verify-no-changes --verbosity diagnostic || echo "::warning::Code formatting issues found"

  # Job 3: Security Scanning
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # Check for vulnerable NuGet packages
      - name: Check NuGet Vulnerabilities
        run: |
          dotnet restore YoutubeRag.sln
          dotnet list package --vulnerable --include-transitive 2>&1 | tee vulnerabilities.txt

          # Check if vulnerabilities were found
          if grep -q "has the following vulnerable packages" vulnerabilities.txt; then
            echo "::warning::Vulnerable packages found in the solution"
            cat vulnerabilities.txt
          else
            echo "::notice::No vulnerable packages found"
          fi

      # Run OWASP Dependency Check
      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'YoutubeRag'
          path: '.'
          format: 'HTML,JSON'
          args: >
            --enableRetired
            --enableExperimental
            --suppression ./.dependency-check-suppressions.xml
        continue-on-error: true

      - name: Upload Dependency Check Results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: dependency-check-report
          path: reports/
          retention-days: 30